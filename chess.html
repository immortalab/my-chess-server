<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Сетевые Шахматы</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #2c3e50; font-family: sans-serif; color: white; }
        .board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 5px solid #34495e; }
        .square { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 40px; cursor: pointer; }
        .white { background-color: #ecf0f1; }
        .black { background-color: #95a5a6; }
        .selected { background-color: #f1c40f !important; }
        #status { margin-bottom: 10px; font-size: 20px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status">Подключение к серверу...</div>
    <div class="board" id="board"></div>
</div>

<script>
    // --- НАСТРОЙКИ СЕРВЕРА ---
    const SERVER_URL = 'https://my-chess-server-5n2e.onrender.com'; // ЗАМЕНИ МЕНЯ!
    const socket = io(SERVER_URL);
    const roomId = "general-room"; // Пока одна комната для всех

    const boardElement = document.getElementById('board');
    const statusText = document.getElementById('status');
    
    const pieces = { 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙' };

    let boardState = [
        ['r','n','b','q','k','b','n','r'], ['p','p','p','p','p','p','p','p'],
        ['','','','','','','',''], ['','','','','','','',''],
        ['','','','','','','',''], ['','','','','','','',''],
        ['P','P','P','P','P','P','P','P'], ['R','N','B','Q','K','B','N','R']
    ];

    let selectedSquare = null;
    let turn = 'white';

    // Слушаем сервер: когда противник сделал ход
    socket.on('move-received', (data) => {
        executeMove(data.fromR, data.fromC, data.toR, data.toC);
        switchTurn();
        createBoard();
    });

    socket.on('connect', () => {
        statusText.textContent = "Подключено. Ход Белых";
        socket.emit('join-room', roomId);
    });

    function createBoard() {
        boardElement.innerHTML = '';
        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const square = document.createElement('div');
                square.className = `square ${(r + c) % 2 === 0 ? 'white' : 'black'}`;
                square.textContent = pieces[boardState[r][c]] || '';
                square.onclick = () => handleSquareClick(r, c);
                if (selectedSquare && selectedSquare.r === r && selectedSquare.c === c) square.classList.add('selected');
                boardElement.appendChild(square);
            }
        }
    }

    function handleSquareClick(r, c) {
        const piece = boardState[r][c];
        const isWhite = piece && piece === piece.toUpperCase();
        const isBlack = piece && piece === piece.toLowerCase();

        if (selectedSquare) {
            if (finalizeMove(selectedSquare.r, selectedSquare.c, r, c)) {
                selectedSquare = null;
                switchTurn();
                createBoard();
                return;
            }
        }

        if ((turn === 'white' && isWhite) || (turn === 'black' && isBlack)) {
            selectedSquare = {r, c};
            createBoard();
        }
    }

    function finalizeMove(fromR, fromC, toR, toC) {
        // Упрощенная проверка: нельзя бить своих
        const target = boardState[toR][toC];
        if (target !== '') {
            const isWhiteTarget = target === target.toUpperCase();
            if ((boardState[fromR][fromC] === boardState[fromR][fromC].toUpperCase()) === isWhiteTarget) return false;
        }

        executeMove(fromR, fromC, toR, toC);
        
        // Отправляем данные на сервер
        socket.emit('make-move', { roomId, fromR, fromC, toR, toC });
        return true;
    }

    function executeMove(fromR, fromC, toR, toC) {
        boardState[toR][toC] = boardState[fromR][fromC];
        boardState[fromR][fromC] = '';
    }

    function switchTurn() {
        turn = (turn === 'white') ? 'black' : 'white';
        statusText.textContent = `Ход ${turn === 'white' ? 'Белых' : 'Черных'}`;
    }

    createBoard();
</script>
</body>
</html>